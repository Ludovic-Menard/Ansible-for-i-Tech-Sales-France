---
# ============================================================================
# Playbook Ansible - Collecte de Baseline de Performance IBM i
# ============================================================================
# Ce playbook collecte les m√©triques de performance baseline avant une mise √† jour
# pour permettre une comparaison ult√©rieure
# ============================================================================
# Usage:
#   ansible-playbook -i inventory.ini collect_baseline.yml
#   ansible-playbook -i inventory.ini collect_baseline.yml --extra-vars "baseline_name=before_ptf_SI12345"
# ============================================================================

- name: Collecte de Baseline de Performance IBM i
  hosts: ibmi_stress_test
  gather_facts: yes
  
  vars_files:
    - vars.yml
  
  vars:
    # Nom de la baseline (peut √™tre surcharg√©)
    baseline_name: "{{ baseline_name | default('baseline_' + ansible_date_time.iso8601_basic_short) }}"
    baseline_file: "{{ baseline_name }}.json"
    
  tasks:
    # -------------------------------------------------------------------------
    # √âtape 1: Informations sur la Baseline
    # -------------------------------------------------------------------------
    - name: Afficher les informations de la baseline
      debug:
        msg:
          - "=========================================="
          - "üìä COLLECTE DE BASELINE DE PERFORMANCE"
          - "=========================================="
          - "H√¥te: {{ inventory_hostname }}"
          - "Nom de la baseline: {{ baseline_name }}"
          - "Date: {{ ansible_date_time.iso8601 }}"
          - "Fichier: {{ baseline_file }}"
          - "=========================================="
      tags: [info]

    - name: Cr√©er le r√©pertoire de r√©sultats local
      local_action:
        module: file
        path: "{{ local_results_dir }}"
        state: directory
        mode: '0755'
      run_once: true
      tags: [setup]

    # -------------------------------------------------------------------------
    # √âtape 2: Collecte des Informations Syst√®me
    # -------------------------------------------------------------------------
    - name: Collecter les informations syst√®me
      setup:
        gather_subset:
          - hardware
          - network
          - virtual
      tags: [collect]

    - name: Extraire les informations syst√®me cl√©s
      set_fact:
        system_info:
          hostname: "{{ inventory_hostname }}"
          os: "{{ ansible_distribution }} {{ ansible_distribution_version }}"
          architecture: "{{ ansible_architecture }}"
          processor_count: "{{ ansible_processor_count }}"
          processor_cores: "{{ ansible_processor_cores }}"
          processor_vcpus: "{{ ansible_processor_vcpus }}"
          memory_mb: "{{ ansible_memtotal_mb }}"
          python_version: "{{ ansible_python_version }}"
      tags: [collect]

    # -------------------------------------------------------------------------
    # √âtape 3: Collecte des M√©triques de Performance Actuelles
    # -------------------------------------------------------------------------
    - name: Collecter les m√©triques CPU actuelles
      shell: |
        {{ python_executable }} -c "
        import psutil
        import json
        cpu_percent = psutil.cpu_percent(interval=2, percpu=True)
        cpu_freq = psutil.cpu_freq()
        load_avg = psutil.getloadavg()
        print(json.dumps({
          'cpu_percent_per_core': cpu_percent,
          'cpu_percent_total': sum(cpu_percent) / len(cpu_percent),
          'cpu_count_logical': psutil.cpu_count(logical=True),
          'cpu_count_physical': psutil.cpu_count(logical=False),
          'cpu_freq_current': cpu_freq.current if cpu_freq else None,
          'cpu_freq_min': cpu_freq.min if cpu_freq else None,
          'cpu_freq_max': cpu_freq.max if cpu_freq else None,
          'load_average_1min': load_avg[0],
          'load_average_5min': load_avg[1],
          'load_average_15min': load_avg[2]
        }))
        "
      register: cpu_metrics
      changed_when: false
      tags: [collect]

    - name: Collecter les m√©triques m√©moire actuelles
      shell: |
        {{ python_executable }} -c "
        import psutil
        import json
        mem = psutil.virtual_memory()
        swap = psutil.swap_memory()
        print(json.dumps({
          'total_gb': round(mem.total / (1024**3), 2),
          'available_gb': round(mem.available / (1024**3), 2),
          'used_gb': round(mem.used / (1024**3), 2),
          'percent': mem.percent,
          'swap_total_gb': round(swap.total / (1024**3), 2),
          'swap_used_gb': round(swap.used / (1024**3), 2),
          'swap_percent': swap.percent
        }))
        "
      register: memory_metrics
      changed_when: false
      tags: [collect]

    - name: Collecter les m√©triques disque actuelles
      shell: |
        {{ python_executable }} -c "
        import psutil
        import json
        disk_io = psutil.disk_io_counters()
        disk_usage = psutil.disk_usage('/')
        print(json.dumps({
          'read_bytes': disk_io.read_bytes,
          'write_bytes': disk_io.write_bytes,
          'read_count': disk_io.read_count,
          'write_count': disk_io.write_count,
          'read_time_ms': disk_io.read_time,
          'write_time_ms': disk_io.write_time,
          'disk_total_gb': round(disk_usage.total / (1024**3), 2),
          'disk_used_gb': round(disk_usage.used / (1024**3), 2),
          'disk_free_gb': round(disk_usage.free / (1024**3), 2),
          'disk_percent': disk_usage.percent
        }))
        "
      register: disk_metrics
      changed_when: false
      tags: [collect]

    - name: Collecter les m√©triques r√©seau actuelles
      shell: |
        {{ python_executable }} -c "
        import psutil
        import json
        net_io = psutil.net_io_counters()
        print(json.dumps({
          'bytes_sent': net_io.bytes_sent,
          'bytes_recv': net_io.bytes_recv,
          'packets_sent': net_io.packets_sent,
          'packets_recv': net_io.packets_recv,
          'errin': net_io.errin,
          'errout': net_io.errout,
          'dropin': net_io.dropin,
          'dropout': net_io.dropout
        }))
        "
      register: network_metrics
      changed_when: false
      tags: [collect]

    # -------------------------------------------------------------------------
    # √âtape 4: Ex√©cution de Tests de Performance Rapides
    # -------------------------------------------------------------------------
    - name: Ex√©cuter un test CPU rapide (30 secondes)
      shell: |
        cd {{ remote_test_dir }}
        {{ python_executable }} ibmi_stress_cpu.py \
          --duration 30 \
          --cores 2 \
          --intensity medium
      register: quick_cpu_test
      when: script_check.stat.exists | default(false)
      failed_when: false
      tags: [test]

    - name: Ex√©cuter un test I/O rapide (30 secondes)
      shell: |
        cd {{ remote_test_dir }}
        {{ python_executable }} ibmi_stress_io.py \
          --duration 30 \
          --processes 1 \
          --file-size 50 \
          --operation mixed \
          --cleanup
      register: quick_io_test
      when: script_check.stat.exists | default(false)
      failed_when: false
      tags: [test]

    # -------------------------------------------------------------------------
    # √âtape 5: Compilation de la Baseline
    # -------------------------------------------------------------------------
    - name: Compiler toutes les m√©triques de baseline
      set_fact:
        baseline_data:
          metadata:
            baseline_name: "{{ baseline_name }}"
            collection_date: "{{ ansible_date_time.iso8601 }}"
            hostname: "{{ inventory_hostname }}"
            purpose: "Performance baseline before system update"
          system_info: "{{ system_info }}"
          current_metrics:
            cpu: "{{ cpu_metrics.stdout | from_json }}"
            memory: "{{ memory_metrics.stdout | from_json }}"
            disk: "{{ disk_metrics.stdout | from_json }}"
            network: "{{ network_metrics.stdout | from_json }}"
          quick_tests:
            cpu_test:
              executed: "{{ quick_cpu_test.rc is defined }}"
              success: "{{ quick_cpu_test.rc == 0 if quick_cpu_test.rc is defined else false }}"
              output: "{{ quick_cpu_test.stdout | default('') }}"
            io_test:
              executed: "{{ quick_io_test.rc is defined }}"
              success: "{{ quick_io_test.rc == 0 if quick_io_test.rc is defined else false }}"
              output: "{{ quick_io_test.stdout | default('') }}"
      tags: [compile]

    - name: Sauvegarder la baseline sur le serveur distant
      copy:
        content: "{{ baseline_data | to_nice_json }}"
        dest: "{{ remote_test_dir }}/results/{{ baseline_file }}"
        mode: '0644'
      tags: [save]

    - name: R√©cup√©rer la baseline localement
      fetch:
        src: "{{ remote_test_dir }}/results/{{ baseline_file }}"
        dest: "{{ local_results_dir }}/{{ baseline_file }}"
        flat: yes
      tags: [save]

    # -------------------------------------------------------------------------
    # √âtape 6: R√©sum√© de la Baseline
    # -------------------------------------------------------------------------
    - name: Afficher le r√©sum√© de la baseline
      debug:
        msg:
          - "=========================================="
          - "‚úÖ BASELINE COLLECT√âE AVEC SUCC√àS"
          - "=========================================="
          - "H√¥te: {{ inventory_hostname }}"
          - "Nom: {{ baseline_name }}"
          - ""
          - "Syst√®me:"
          - "  OS: {{ system_info.os }}"
          - "  CPU: {{ system_info.processor_vcpus }} vCPUs"
          - "  M√©moire: {{ system_info.memory_mb }} MB"
          - ""
          - "M√©triques Actuelles:"
          - "  CPU moyen: {{ (cpu_metrics.stdout | from_json).cpu_percent_total | round(2) }}%"
          - "  Load average: {{ (cpu_metrics.stdout | from_json).load_average_1min | round(2) }}"
          - "  M√©moire utilis√©e: {{ (memory_metrics.stdout | from_json).percent | round(2) }}%"
          - "  Disque utilis√©: {{ (disk_metrics.stdout | from_json).disk_percent | round(2) }}%"
          - ""
          - "Tests Rapides:"
          - "  CPU: {{ 'R√âUSSI ‚úÖ' if quick_cpu_test.rc == 0 else 'NON EX√âCUT√â' }}"
          - "  I/O: {{ 'R√âUSSI ‚úÖ' if quick_io_test.rc == 0 else 'NON EX√âCUT√â' }}"
          - ""
          - "Fichier sauvegard√©:"
          - "  Local: {{ local_results_dir }}/{{ baseline_file }}"
          - "  Distant: {{ remote_test_dir }}/results/{{ baseline_file }}"
          - ""
          - "Pour comparer apr√®s mise √† jour:"
          - "  ansible-playbook -i inventory.ini compare_results.yml \\"
          - "    --extra-vars \"baseline_file={{ local_results_dir }}/{{ baseline_file }}\""
          - "=========================================="
      tags: [summary]

# ============================================================================
# Fin du Playbook
# ============================================================================

# Made with Bob
