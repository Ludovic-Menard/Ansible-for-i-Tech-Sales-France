---
# ============================================================================
# Playbook Ansible - Comparaison des R√©sultats Avant/Apr√®s Mise √† Jour
# ============================================================================
# Ce playbook compare les m√©triques de performance avant et apr√®s une mise √† jour
# et g√©n√®re un rapport de comparaison
# ============================================================================
# Usage:
#   ansible-playbook -i inventory.ini compare_results.yml \
#     --extra-vars "baseline_file=results/baseline_20241216.json validation_file=results/baseline_20241217.json"
# ============================================================================

- name: Comparaison des R√©sultats de Performance IBM i
  hosts: ibmi_stress_test
  gather_facts: yes
  
  vars_files:
    - vars.yml
  
  vars:
    # Fichiers √† comparer (doivent √™tre fournis)
    comparison_report: "comparison_{{ inventory_hostname }}_{{ ansible_date_time.iso8601_basic_short }}.json"
    
  tasks:
    # -------------------------------------------------------------------------
    # √âtape 1: V√©rification des Fichiers
    # -------------------------------------------------------------------------
    - name: V√©rifier que les fichiers de baseline et validation sont fournis
      fail:
        msg: |
          Les fichiers de baseline et validation doivent √™tre fournis.
          Usage: ansible-playbook compare_results.yml \
            --extra-vars "baseline_file=results/baseline.json validation_file=results/validation.json"
      when: baseline_file is not defined or validation_file is not defined
      tags: [check]

    - name: V√©rifier l'existence du fichier baseline
      local_action:
        module: stat
        path: "{{ baseline_file }}"
      register: baseline_check
      tags: [check]

    - name: V√©rifier l'existence du fichier validation
      local_action:
        module: stat
        path: "{{ validation_file }}"
      register: validation_check
      tags: [check]

    - name: Erreur si les fichiers n'existent pas
      fail:
        msg: |
          Fichier(s) introuvable(s):
          {% if not baseline_check.stat.exists %}  - Baseline: {{ baseline_file }}{% endif %}
          {% if not validation_check.stat.exists %}  - Validation: {{ validation_file }}{% endif %}
      when: not baseline_check.stat.exists or not validation_check.stat.exists
      tags: [check]

    - name: Afficher les informations de comparaison
      debug:
        msg:
          - "=========================================="
          - "üìä COMPARAISON DES PERFORMANCES"
          - "=========================================="
          - "H√¥te: {{ inventory_hostname }}"
          - "Fichier baseline: {{ baseline_file }}"
          - "Fichier validation: {{ validation_file }}"
          - "Rapport: {{ comparison_report }}"
          - "=========================================="
      tags: [info]

    # -------------------------------------------------------------------------
    # √âtape 2: Chargement des Donn√©es
    # -------------------------------------------------------------------------
    - name: Charger les donn√©es baseline
      set_fact:
        baseline_data: "{{ lookup('file', baseline_file) | from_json }}"
      tags: [load]

    - name: Charger les donn√©es validation
      set_fact:
        validation_data: "{{ lookup('file', validation_file) | from_json }}"
      tags: [load]

    - name: Afficher les dates de collecte
      debug:
        msg:
          - "Baseline collect√©e: {{ baseline_data.metadata.collection_date }}"
          - "Validation collect√©e: {{ validation_data.metadata.collection_date }}"
      tags: [load]

    # -------------------------------------------------------------------------
    # √âtape 3: Comparaison des M√©triques CPU
    # -------------------------------------------------------------------------
    - name: Comparer les m√©triques CPU
      set_fact:
        cpu_comparison:
          baseline:
            cpu_percent: "{{ baseline_data.current_metrics.cpu.cpu_percent_total }}"
            load_avg_1min: "{{ baseline_data.current_metrics.cpu.load_average_1min }}"
            load_avg_5min: "{{ baseline_data.current_metrics.cpu.load_average_5min }}"
          validation:
            cpu_percent: "{{ validation_data.current_metrics.cpu.cpu_percent_total }}"
            load_avg_1min: "{{ validation_data.current_metrics.cpu.load_average_1min }}"
            load_avg_5min: "{{ validation_data.current_metrics.cpu.load_average_5min }}"
          difference:
            cpu_percent: "{{ ((validation_data.current_metrics.cpu.cpu_percent_total | float) - (baseline_data.current_metrics.cpu.cpu_percent_total | float)) | round(2) }}"
            load_avg_1min: "{{ ((validation_data.current_metrics.cpu.load_average_1min | float) - (baseline_data.current_metrics.cpu.load_average_1min | float)) | round(2) }}"
            load_avg_5min: "{{ ((validation_data.current_metrics.cpu.load_average_5min | float) - (baseline_data.current_metrics.cpu.load_average_5min | float)) | round(2) }}"
          percentage_change:
            cpu_percent: "{{ (((validation_data.current_metrics.cpu.cpu_percent_total | float) - (baseline_data.current_metrics.cpu.cpu_percent_total | float)) / (baseline_data.current_metrics.cpu.cpu_percent_total | float) * 100) | round(2) if baseline_data.current_metrics.cpu.cpu_percent_total | float > 0 else 0 }}"
            load_avg_1min: "{{ (((validation_data.current_metrics.cpu.load_average_1min | float) - (baseline_data.current_metrics.cpu.load_average_1min | float)) / (baseline_data.current_metrics.cpu.load_average_1min | float) * 100) | round(2) if baseline_data.current_metrics.cpu.load_average_1min | float > 0 else 0 }}"
      tags: [compare]

    # -------------------------------------------------------------------------
    # √âtape 4: Comparaison des M√©triques M√©moire
    # -------------------------------------------------------------------------
    - name: Comparer les m√©triques m√©moire
      set_fact:
        memory_comparison:
          baseline:
            percent: "{{ baseline_data.current_metrics.memory.percent }}"
            used_gb: "{{ baseline_data.current_metrics.memory.used_gb }}"
            available_gb: "{{ baseline_data.current_metrics.memory.available_gb }}"
          validation:
            percent: "{{ validation_data.current_metrics.memory.percent }}"
            used_gb: "{{ validation_data.current_metrics.memory.used_gb }}"
            available_gb: "{{ validation_data.current_metrics.memory.available_gb }}"
          difference:
            percent: "{{ ((validation_data.current_metrics.memory.percent | float) - (baseline_data.current_metrics.memory.percent | float)) | round(2) }}"
            used_gb: "{{ ((validation_data.current_metrics.memory.used_gb | float) - (baseline_data.current_metrics.memory.used_gb | float)) | round(2) }}"
          percentage_change:
            percent: "{{ (((validation_data.current_metrics.memory.percent | float) - (baseline_data.current_metrics.memory.percent | float)) / (baseline_data.current_metrics.memory.percent | float) * 100) | round(2) if baseline_data.current_metrics.memory.percent | float > 0 else 0 }}"
      tags: [compare]

    # -------------------------------------------------------------------------
    # √âtape 5: Comparaison des M√©triques Disque
    # -------------------------------------------------------------------------
    - name: Comparer les m√©triques disque
      set_fact:
        disk_comparison:
          baseline:
            percent: "{{ baseline_data.current_metrics.disk.disk_percent }}"
            used_gb: "{{ baseline_data.current_metrics.disk.disk_used_gb }}"
            free_gb: "{{ baseline_data.current_metrics.disk.disk_free_gb }}"
          validation:
            percent: "{{ validation_data.current_metrics.disk.disk_percent }}"
            used_gb: "{{ validation_data.current_metrics.disk.disk_used_gb }}"
            free_gb: "{{ validation_data.current_metrics.disk.disk_free_gb }}"
          difference:
            percent: "{{ ((validation_data.current_metrics.disk.disk_percent | float) - (baseline_data.current_metrics.disk.disk_percent | float)) | round(2) }}"
            used_gb: "{{ ((validation_data.current_metrics.disk.disk_used_gb | float) - (baseline_data.current_metrics.disk.disk_used_gb | float)) | round(2) }}"
      tags: [compare]

    # -------------------------------------------------------------------------
    # √âtape 6: √âvaluation des Changements
    # -------------------------------------------------------------------------
    - name: √âvaluer les changements de performance
      set_fact:
        performance_assessment:
          cpu:
            status: "{{ 'D√âGRAD√â' if cpu_comparison.percentage_change.cpu_percent | float > performance_thresholds.cpu_degradation_critical else ('ATTENTION' if cpu_comparison.percentage_change.cpu_percent | float > performance_thresholds.cpu_degradation_warning else 'OK') }}"
            severity: "{{ 'critical' if cpu_comparison.percentage_change.cpu_percent | float > performance_thresholds.cpu_degradation_critical else ('warning' if cpu_comparison.percentage_change.cpu_percent | float > performance_thresholds.cpu_degradation_warning else 'normal') }}"
          memory:
            status: "{{ 'D√âGRAD√â' if memory_comparison.percentage_change.percent | float > performance_thresholds.memory_increase_critical else ('ATTENTION' if memory_comparison.percentage_change.percent | float > performance_thresholds.memory_increase_warning else 'OK') }}"
            severity: "{{ 'critical' if memory_comparison.percentage_change.percent | float > performance_thresholds.memory_increase_critical else ('warning' if memory_comparison.percentage_change.percent | float > performance_thresholds.memory_increase_warning else 'normal') }}"
          overall:
            status: "{{ 'D√âGRAD√â' if (cpu_comparison.percentage_change.cpu_percent | float > performance_thresholds.cpu_degradation_critical or memory_comparison.percentage_change.percent | float > performance_thresholds.memory_increase_critical) else ('ATTENTION' if (cpu_comparison.percentage_change.cpu_percent | float > performance_thresholds.cpu_degradation_warning or memory_comparison.percentage_change.percent | float > performance_thresholds.memory_increase_warning) else 'OK') }}"
      tags: [evaluate]

    # -------------------------------------------------------------------------
    # √âtape 7: G√©n√©ration du Rapport de Comparaison
    # -------------------------------------------------------------------------
    - name: Compiler le rapport de comparaison
      set_fact:
        comparison_report_data:
          metadata:
            report_date: "{{ ansible_date_time.iso8601 }}"
            hostname: "{{ inventory_hostname }}"
            baseline_file: "{{ baseline_file }}"
            validation_file: "{{ validation_file }}"
            baseline_date: "{{ baseline_data.metadata.collection_date }}"
            validation_date: "{{ validation_data.metadata.collection_date }}"
          system_info:
            baseline: "{{ baseline_data.system_info }}"
            validation: "{{ validation_data.system_info }}"
          comparisons:
            cpu: "{{ cpu_comparison }}"
            memory: "{{ memory_comparison }}"
            disk: "{{ disk_comparison }}"
          assessment: "{{ performance_assessment }}"
          recommendations: "{{ recommendations | default([]) }}"
      tags: [report]

    - name: G√©n√©rer des recommandations
      set_fact:
        recommendations:
          - "{{ 'CPU: D√©gradation significative d√©tect√©e (+' + (cpu_comparison.percentage_change.cpu_percent | string) + '%). Investigation recommand√©e.' if performance_assessment.cpu.severity == 'critical' else '' }}"
          - "{{ 'CPU: L√©g√®re augmentation d√©tect√©e (+' + (cpu_comparison.percentage_change.cpu_percent | string) + '%). Surveillance recommand√©e.' if performance_assessment.cpu.severity == 'warning' else '' }}"
          - "{{ 'M√©moire: Augmentation significative d√©tect√©e (+' + (memory_comparison.percentage_change.percent | string) + '%). V√©rifier les fuites m√©moire.' if performance_assessment.memory.severity == 'critical' else '' }}"
          - "{{ 'M√©moire: L√©g√®re augmentation d√©tect√©e (+' + (memory_comparison.percentage_change.percent | string) + '%). Surveillance recommand√©e.' if performance_assessment.memory.severity == 'warning' else '' }}"
          - "{{ 'Performances globales: Aucune d√©gradation significative d√©tect√©e.' if performance_assessment.overall.status == 'OK' else '' }}"
      tags: [report]

    - name: Filtrer les recommandations vides
      set_fact:
        filtered_recommendations: "{{ recommendations | select('ne', '') | list }}"
      tags: [report]

    - name: Mettre √† jour le rapport avec les recommandations
      set_fact:
        comparison_report_data: "{{ comparison_report_data | combine({'recommendations': filtered_recommendations}) }}"
      tags: [report]

    # -------------------------------------------------------------------------
    # √âtape 8: Sauvegarde du Rapport
    # -------------------------------------------------------------------------
    - name: Cr√©er le r√©pertoire de rapports local
      local_action:
        module: file
        path: "{{ local_reports_dir }}"
        state: directory
        mode: '0755'
      run_once: true
      tags: [save]

    - name: Sauvegarder le rapport de comparaison localement
      local_action:
        module: copy
        content: "{{ comparison_report_data | to_nice_json }}"
        dest: "{{ local_reports_dir }}/{{ comparison_report }}"
      tags: [save]

    # -------------------------------------------------------------------------
    # √âtape 9: Affichage du R√©sum√©
    # -------------------------------------------------------------------------
    - name: Afficher le r√©sum√© de la comparaison
      debug:
        msg:
          - "=========================================="
          - "üìä R√âSUM√â DE LA COMPARAISON"
          - "=========================================="
          - "H√¥te: {{ inventory_hostname }}"
          - "Statut Global: {{ performance_assessment.overall.status }}"
          - ""
          - "CPU:"
          - "  Baseline: {{ cpu_comparison.baseline.cpu_percent }}%"
          - "  Validation: {{ cpu_comparison.validation.cpu_percent }}%"
          - "  Changement: {{ cpu_comparison.difference.cpu_percent }}% ({{ cpu_comparison.percentage_change.cpu_percent }}%)"
          - "  Statut: {{ performance_assessment.cpu.status }}"
          - ""
          - "M√©moire:"
          - "  Baseline: {{ memory_comparison.baseline.percent }}%"
          - "  Validation: {{ memory_comparison.validation.percent }}%"
          - "  Changement: {{ memory_comparison.difference.percent }}% ({{ memory_comparison.percentage_change.percent }}%)"
          - "  Statut: {{ performance_assessment.memory.status }}"
          - ""
          - "Disque:"
          - "  Baseline: {{ disk_comparison.baseline.percent }}%"
          - "  Validation: {{ disk_comparison.validation.percent }}%"
          - "  Changement: {{ disk_comparison.difference.percent }}%"
          - ""
          - "Recommandations:"
          - "{% for rec in filtered_recommendations %}  - {{ rec }}{% endfor %}"
          - ""
          - "Rapport sauvegard√©:"
          - "  {{ local_reports_dir }}/{{ comparison_report }}"
          - "=========================================="
      tags: [summary]

# ============================================================================
# Fin du Playbook
# ============================================================================

# Made with Bob
