---
# ============================================================================
# Playbook Ansible - Ex√©cution des Tests de Stress I/O sur IBM i
# ============================================================================
# Ce playbook ex√©cute des tests de stress I/O sur les serveurs IBM i
# et collecte les m√©triques de performance disque
# ============================================================================
# Usage:
#   ansible-playbook -i inventory.ini run_io_stress.yml
#   ansible-playbook -i inventory.ini run_io_stress.yml --extra-vars "io_processes=4"
#   ansible-playbook -i inventory.ini run_io_stress.yml --limit ibmi-test
# ============================================================================

- name: Ex√©cution des Tests de Stress I/O sur IBM i
  hosts: ibmi_stress_test
  gather_facts: yes
  
  vars_files:
    - vars.yml
  
  vars:
    # Nom du fichier de r√©sultats avec horodatage
    results_file: "io_stress_{{ inventory_hostname }}_{{ ansible_date_time.iso8601_basic_short }}.json"
    log_file: "io_stress_{{ inventory_hostname }}_{{ ansible_date_time.iso8601_basic_short }}.log"
  
  tasks:
    # -------------------------------------------------------------------------
    # √âtape 1: V√©rifications Pr√©alables
    # -------------------------------------------------------------------------
    - name: V√©rifier que les scripts sont d√©ploy√©s
      stat:
        path: "{{ remote_test_dir }}/ibmi_stress_io.py"
      register: script_check
      tags: [check]

    - name: Erreur si le script n'est pas d√©ploy√©
      fail:
        msg: |
          Le script ibmi_stress_io.py n'est pas d√©ploy√© sur {{ inventory_hostname }}.
          Ex√©cutez d'abord: ansible-playbook -i inventory.ini deploy_stress_tools.yml
      when: not script_check.stat.exists
      tags: [check]

    - name: V√©rifier l'espace disque disponible
      shell: df -h {{ io_test_directory }} | tail -1 | awk '{print $4, $5}'
      register: disk_space
      changed_when: false
      tags: [check]

    - name: Afficher l'espace disque disponible
      debug:
        msg: "Espace disque: {{ disk_space.stdout }}"
      tags: [check]

    - name: Calculer l'espace requis pour le test
      set_fact:
        required_space_mb: "{{ (io_file_size_mb | int * io_processes | int * 2) }}"
      tags: [check]

    - name: Avertissement si l'espace disque est limit√©
      debug:
        msg: |
          ATTENTION: Le test n√©cessite environ {{ required_space_mb }} MB d'espace disque.
          V√©rifiez que vous avez suffisamment d'espace disponible.
      tags: [check]

    # -------------------------------------------------------------------------
    # √âtape 2: Collecte des M√©triques Disque Avant le Test
    # -------------------------------------------------------------------------
    - name: Collecter les m√©triques disque avant le test
      shell: |
        {{ python_executable }} -c "
        import psutil
        import json
        disk_io = psutil.disk_io_counters()
        disk_usage = psutil.disk_usage('{{ io_test_directory }}')
        print(json.dumps({
          'read_bytes': disk_io.read_bytes,
          'write_bytes': disk_io.write_bytes,
          'read_count': disk_io.read_count,
          'write_count': disk_io.write_count,
          'disk_total_gb': round(disk_usage.total / (1024**3), 2),
          'disk_used_gb': round(disk_usage.used / (1024**3), 2),
          'disk_free_gb': round(disk_usage.free / (1024**3), 2),
          'disk_percent': disk_usage.percent
        }))
        "
      register: baseline_metrics
      changed_when: false
      tags: [baseline]

    - name: Afficher les m√©triques baseline
      debug:
        msg: "M√©triques I/O avant test: {{ baseline_metrics.stdout | from_json }}"
      tags: [baseline]

    # -------------------------------------------------------------------------
    # √âtape 3: Pr√©paration du Test
    # -------------------------------------------------------------------------
    - name: Cr√©er le r√©pertoire de test I/O
      file:
        path: "{{ io_test_directory }}"
        state: directory
        mode: '0755'
      tags: [setup]

    - name: Afficher les param√®tres du test
      debug:
        msg:
          - "=========================================="
          - "üöÄ LANCEMENT DU TEST DE STRESS I/O"
          - "=========================================="
          - "H√¥te: {{ inventory_hostname }}"
          - "Dur√©e: {{ io_test_duration }} secondes ({{ (io_test_duration / 60) | round(1) }} minutes)"
          - "Nombre de processus: {{ io_processes }}"
          - "Taille fichier: {{ io_file_size_mb }} MB"
          - "Op√©ration: {{ io_operation }}"
          - "R√©pertoire: {{ io_test_directory }}"
          - "Espace requis: ~{{ required_space_mb }} MB"
          - "Fichier de r√©sultats: {{ results_file }}"
          - "=========================================="
      tags: [info]

    - name: Cr√©er le r√©pertoire de r√©sultats local
      local_action:
        module: file
        path: "{{ local_results_dir }}"
        state: directory
        mode: '0755'
      run_once: true
      tags: [setup]

    # -------------------------------------------------------------------------
    # √âtape 4: Ex√©cution du Test de Stress I/O
    # -------------------------------------------------------------------------
    - name: Ex√©cuter le test de stress I/O
      shell: |
        cd {{ remote_test_dir }}
        {{ python_executable }} ibmi_stress_io.py \
          --duration {{ io_test_duration }} \
          --processes {{ io_processes }} \
          --directory {{ io_test_directory }} \
          --file-size {{ io_file_size_mb }} \
          --operation {{ io_operation }} \
          {{ '--cleanup' if cleanup_after_test else '' }} \
          2>&1 | tee logs/{{ log_file }}
      register: stress_test_output
      async: "{{ io_test_duration + 180 }}"
      poll: 10
      tags: [execute]

    - name: Afficher la sortie du test
      debug:
        var: stress_test_output.stdout_lines
      when: stress_test_output.stdout_lines is defined
      tags: [execute]

    # -------------------------------------------------------------------------
    # √âtape 5: Collecte des M√©triques Apr√®s le Test
    # -------------------------------------------------------------------------
    - name: Attendre la stabilisation du syst√®me (30 secondes)
      pause:
        seconds: 30
      tags: [post-test]

    - name: Collecter les m√©triques disque apr√®s le test
      shell: |
        {{ python_executable }} -c "
        import psutil
        import json
        disk_io = psutil.disk_io_counters()
        disk_usage = psutil.disk_usage('{{ io_test_directory }}')
        print(json.dumps({
          'read_bytes': disk_io.read_bytes,
          'write_bytes': disk_io.write_bytes,
          'read_count': disk_io.read_count,
          'write_count': disk_io.write_count,
          'disk_total_gb': round(disk_usage.total / (1024**3), 2),
          'disk_used_gb': round(disk_usage.used / (1024**3), 2),
          'disk_free_gb': round(disk_usage.free / (1024**3), 2),
          'disk_percent': disk_usage.percent
        }))
        "
      register: post_test_metrics
      changed_when: false
      tags: [post-test]

    - name: Afficher les m√©triques post-test
      debug:
        msg: "M√©triques I/O apr√®s test: {{ post_test_metrics.stdout | from_json }}"
      tags: [post-test]

    # -------------------------------------------------------------------------
    # √âtape 6: Extraction et Analyse des R√©sultats
    # -------------------------------------------------------------------------
    - name: Calculer les statistiques I/O
      set_fact:
        io_stats:
          bytes_read: "{{ ((post_test_metrics.stdout | from_json).read_bytes - (baseline_metrics.stdout | from_json).read_bytes) }}"
          bytes_written: "{{ ((post_test_metrics.stdout | from_json).write_bytes - (baseline_metrics.stdout | from_json).write_bytes) }}"
          read_operations: "{{ ((post_test_metrics.stdout | from_json).read_count - (baseline_metrics.stdout | from_json).read_count) }}"
          write_operations: "{{ ((post_test_metrics.stdout | from_json).write_count - (baseline_metrics.stdout | from_json).write_count) }}"
      tags: [analysis]

    - name: Calculer les d√©bits
      set_fact:
        throughput_stats:
          read_mb_per_sec: "{{ ((io_stats.bytes_read | int) / (1024 * 1024) / io_test_duration) | round(2) }}"
          write_mb_per_sec: "{{ ((io_stats.bytes_written | int) / (1024 * 1024) / io_test_duration) | round(2) }}"
          total_gb: "{{ (((io_stats.bytes_read | int) + (io_stats.bytes_written | int)) / (1024**3)) | round(2) }}"
      tags: [analysis]

    - name: Cr√©er le r√©sum√© des r√©sultats
      set_fact:
        test_results:
          hostname: "{{ inventory_hostname }}"
          test_type: "io_stress"
          timestamp: "{{ ansible_date_time.iso8601 }}"
          parameters:
            duration: "{{ io_test_duration }}"
            processes: "{{ io_processes }}"
            file_size_mb: "{{ io_file_size_mb }}"
            operation: "{{ io_operation }}"
            directory: "{{ io_test_directory }}"
          baseline_metrics: "{{ baseline_metrics.stdout | from_json }}"
          post_test_metrics: "{{ post_test_metrics.stdout | from_json }}"
          io_statistics:
            bytes_read: "{{ io_stats.bytes_read }}"
            bytes_written: "{{ io_stats.bytes_written }}"
            read_operations: "{{ io_stats.read_operations }}"
            write_operations: "{{ io_stats.write_operations }}"
            read_throughput_mbps: "{{ throughput_stats.read_mb_per_sec }}"
            write_throughput_mbps: "{{ throughput_stats.write_mb_per_sec }}"
            total_data_gb: "{{ throughput_stats.total_gb }}"
          test_output: "{{ stress_test_output.stdout }}"
          return_code: "{{ stress_test_output.rc }}"
          success: "{{ stress_test_output.rc == 0 }}"
      tags: [results]

    - name: Sauvegarder les r√©sultats en JSON sur le serveur distant
      copy:
        content: "{{ test_results | to_nice_json }}"
        dest: "{{ remote_test_dir }}/results/{{ results_file }}"
        mode: '0644'
      tags: [results]

    - name: R√©cup√©rer les r√©sultats localement
      fetch:
        src: "{{ remote_test_dir }}/results/{{ results_file }}"
        dest: "{{ local_results_dir }}/{{ results_file }}"
        flat: yes
      tags: [results]

    - name: R√©cup√©rer le fichier de log localement
      fetch:
        src: "{{ remote_test_dir }}/logs/{{ log_file }}"
        dest: "{{ local_results_dir }}/{{ log_file }}"
        flat: yes
      when: stress_test_output.rc == 0
      tags: [results]

    # -------------------------------------------------------------------------
    # √âtape 7: Rapport Final
    # -------------------------------------------------------------------------
    - name: Afficher le r√©sum√© des performances I/O
      debug:
        msg:
          - "=========================================="
          - "üìä R√âSUM√â DES PERFORMANCES I/O"
          - "=========================================="
          - "H√¥te: {{ inventory_hostname }}"
          - "Test: {{ 'R√âUSSI ‚úÖ' if stress_test_output.rc == 0 else '√âCHOU√â ‚ùå' }}"
          - ""
          - "Donn√©es Transf√©r√©es:"
          - "  Lecture: {{ (io_stats.bytes_read | int / (1024**3)) | round(2) }} GB"
          - "  √âcriture: {{ (io_stats.bytes_written | int / (1024**3)) | round(2) }} GB"
          - "  Total: {{ throughput_stats.total_gb }} GB"
          - ""
          - "Op√©rations:"
          - "  Lectures: {{ io_stats.read_operations }}"
          - "  √âcritures: {{ io_stats.write_operations }}"
          - ""
          - "D√©bits:"
          - "  Lecture: {{ throughput_stats.read_mb_per_sec }} MB/s"
          - "  √âcriture: {{ throughput_stats.write_mb_per_sec }} MB/s"
          - ""
          - "Utilisation Disque:"
          - "  Avant: {{ (baseline_metrics.stdout | from_json).disk_percent }}%"
          - "  Apr√®s: {{ (post_test_metrics.stdout | from_json).disk_percent }}%"
          - ""
          - "Fichiers g√©n√©r√©s:"
          - "  R√©sultats: {{ local_results_dir }}/{{ results_file }}"
          - "  Log: {{ local_results_dir }}/{{ log_file }}"
          - "=========================================="
      tags: [summary]

    # -------------------------------------------------------------------------
    # √âtape 8: Nettoyage Final
    # -------------------------------------------------------------------------
    - name: Nettoyer le r√©pertoire de test I/O
      file:
        path: "{{ io_test_directory }}"
        state: absent
      when: cleanup_after_test | bool
      tags: [cleanup]

    - name: Confirmer le nettoyage
      debug:
        msg: "‚úÖ R√©pertoire de test {{ io_test_directory }} nettoy√©"
      when: cleanup_after_test | bool
      tags: [cleanup]

# ============================================================================
# Fin du Playbook
# ============================================================================

# Made with Bob
