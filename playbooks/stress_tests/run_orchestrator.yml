---
# ============================================================================
# Playbook Ansible - Orchestrateur de Tests de Stress IBM i
# ============================================================================
# Ce playbook lance l'orchestrateur qui ex√©cute des sc√©narios pr√©d√©finis
# combinant tests CPU, I/O et monitoring
# ============================================================================
# Usage:
#   ansible-playbook -i inventory.ini run_orchestrator.yml
#   ansible-playbook -i inventory.ini run_orchestrator.yml --extra-vars "orchestrator_scenario=demo_intensive"
# ============================================================================

- name: Orchestrateur de Tests de Stress IBM i
  hosts: ibmi_stress_test
  gather_facts: yes
  
  vars_files:
    - vars.yml
  
  vars:
    # Nom du fichier de r√©sultats avec horodatage
    results_file: "orchestrator_{{ inventory_hostname }}_{{ ansible_date_time.iso8601_basic_short }}.json"
    log_file: "orchestrator_{{ inventory_hostname }}_{{ ansible_date_time.iso8601_basic_short }}.log"
    
  tasks:
    # -------------------------------------------------------------------------
    # √âtape 1: V√©rifications Pr√©alables
    # -------------------------------------------------------------------------
    - name: V√©rifier que l'orchestrateur est d√©ploy√©
      stat:
        path: "{{ remote_test_dir }}/ibmi_stress_orchestrator.py"
      register: script_check
      tags: [check]

    - name: Erreur si le script n'est pas d√©ploy√©
      fail:
        msg: |
          Le script ibmi_stress_orchestrator.py n'est pas d√©ploy√© sur {{ inventory_hostname }}.
          Ex√©cutez d'abord: ansible-playbook -i inventory.ini deploy_stress_tools.yml
      when: not script_check.stat.exists
      tags: [check]

    - name: Lister les sc√©narios disponibles
      shell: |
        {{ python_executable }} {{ remote_test_dir }}/ibmi_stress_orchestrator.py --list-scenarios
      register: available_scenarios
      changed_when: false
      tags: [info]

    - name: Afficher les sc√©narios disponibles
      debug:
        var: available_scenarios.stdout_lines
      tags: [info]

    # -------------------------------------------------------------------------
    # √âtape 2: Pr√©paration du Sc√©nario
    # -------------------------------------------------------------------------
    - name: D√©terminer le sc√©nario √† ex√©cuter
      set_fact:
        scenario_to_run: "{{ orchestrator_scenario }}"
        scenario_file: "{{ orchestrator_custom_file | default('') }}"
      tags: [setup]

    - name: Afficher les param√®tres du sc√©nario
      debug:
        msg:
          - "=========================================="
          - "üéØ LANCEMENT DE L'ORCHESTRATEUR"
          - "=========================================="
          - "H√¥te: {{ inventory_hostname }}"
          - "Sc√©nario: {{ scenario_to_run }}"
          - "{% if scenario_file %}Fichier personnalis√©: {{ scenario_file }}{% endif %}"
          - "Fichier de r√©sultats: {{ results_file }}"
          - "=========================================="
      tags: [info]

    - name: Cr√©er le r√©pertoire de r√©sultats local
      local_action:
        module: file
        path: "{{ local_results_dir }}"
        state: directory
        mode: '0755'
      run_once: true
      tags: [setup]

    # -------------------------------------------------------------------------
    # √âtape 3: Copie du Fichier de Sc√©nario Personnalis√© (si fourni)
    # -------------------------------------------------------------------------
    - name: Copier le fichier de sc√©nario personnalis√©
      copy:
        src: "{{ scenario_file }}"
        dest: "{{ remote_test_dir }}/custom_scenario.json"
        mode: '0644'
      when: scenario_file != ''
      tags: [setup]

    # -------------------------------------------------------------------------
    # √âtape 4: Ex√©cution de l'Orchestrateur
    # -------------------------------------------------------------------------
    - name: Ex√©cuter l'orchestrateur avec sc√©nario pr√©d√©fini
      shell: |
        cd {{ remote_test_dir }}
        {{ python_executable }} ibmi_stress_orchestrator.py \
          --scenario {{ scenario_to_run }} \
          2>&1 | tee logs/{{ log_file }}
      register: orchestrator_output
      async: 7200
      poll: 15
      when: scenario_file == ''
      tags: [execute]

    - name: Ex√©cuter l'orchestrateur avec sc√©nario personnalis√©
      shell: |
        cd {{ remote_test_dir }}
        {{ python_executable }} ibmi_stress_orchestrator.py \
          --file custom_scenario.json \
          2>&1 | tee logs/{{ log_file }}
      register: orchestrator_custom_output
      async: 7200
      poll: 15
      when: scenario_file != ''
      tags: [execute]

    - name: D√©finir la sortie finale
      set_fact:
        final_output: "{{ orchestrator_output if scenario_file == '' else orchestrator_custom_output }}"
      tags: [execute]

    - name: Afficher la sortie de l'orchestrateur
      debug:
        var: final_output.stdout_lines
      when: final_output.stdout_lines is defined
      tags: [execute]

    # -------------------------------------------------------------------------
    # √âtape 5: Collecte des R√©sultats
    # -------------------------------------------------------------------------
    - name: Rechercher les fichiers de m√©triques g√©n√©r√©s
      find:
        paths: "{{ remote_test_dir }}/results"
        patterns: "metrics_*.jsonl"
        age: -1h
      register: metrics_files
      tags: [results]

    - name: Afficher les fichiers de m√©triques trouv√©s
      debug:
        msg: "Fichiers de m√©triques: {{ metrics_files.files | map(attribute='path') | list }}"
      when: metrics_files.files | length > 0
      tags: [results]

    - name: R√©cup√©rer les fichiers de m√©triques localement
      fetch:
        src: "{{ item.path }}"
        dest: "{{ local_results_dir }}/{{ item.path | basename }}"
        flat: yes
      loop: "{{ metrics_files.files }}"
      when: metrics_files.files | length > 0
      tags: [results]

    - name: R√©cup√©rer le fichier de log localement
      fetch:
        src: "{{ remote_test_dir }}/logs/{{ log_file }}"
        dest: "{{ local_results_dir }}/{{ log_file }}"
        flat: yes
      when: final_output.rc == 0
      tags: [results]

    # -------------------------------------------------------------------------
    # √âtape 6: Analyse des R√©sultats
    # -------------------------------------------------------------------------
    - name: Extraire les statistiques du sc√©nario
      set_fact:
        scenario_results:
          hostname: "{{ inventory_hostname }}"
          test_type: "orchestrator"
          scenario: "{{ scenario_to_run }}"
          timestamp: "{{ ansible_date_time.iso8601 }}"
          return_code: "{{ final_output.rc }}"
          success: "{{ final_output.rc == 0 }}"
          metrics_files_count: "{{ metrics_files.files | length }}"
          output: "{{ final_output.stdout }}"
      tags: [analysis]

    - name: Sauvegarder les r√©sultats du sc√©nario
      copy:
        content: "{{ scenario_results | to_nice_json }}"
        dest: "{{ remote_test_dir }}/results/{{ results_file }}"
        mode: '0644'
      tags: [results]

    - name: R√©cup√©rer le fichier de r√©sultats localement
      fetch:
        src: "{{ remote_test_dir }}/results/{{ results_file }}"
        dest: "{{ local_results_dir }}/{{ results_file }}"
        flat: yes
      tags: [results]

    # -------------------------------------------------------------------------
    # √âtape 7: R√©sum√© de l'Ex√©cution
    # -------------------------------------------------------------------------
    - name: Afficher le r√©sum√© de l'orchestrateur
      debug:
        msg:
          - "=========================================="
          - "üìä R√âSUM√â DE L'ORCHESTRATEUR"
          - "=========================================="
          - "H√¥te: {{ inventory_hostname }}"
          - "Sc√©nario: {{ scenario_to_run }}"
          - "Ex√©cution: {{ 'R√âUSSIE ‚úÖ' if final_output.rc == 0 else '√âCHOU√âE ‚ùå' }}"
          - ""
          - "Fichiers g√©n√©r√©s:"
          - "  R√©sultats: {{ local_results_dir }}/{{ results_file }}"
          - "  Log: {{ local_results_dir }}/{{ log_file }}"
          - "  M√©triques: {{ metrics_files.files | length }} fichier(s)"
          - ""
          - "Pour analyser les m√©triques:"
          - "  cat {{ local_results_dir }}/metrics_*.jsonl | jq ."
          - "=========================================="
      tags: [summary]

    # -------------------------------------------------------------------------
    # √âtape 8: Nettoyage (Optionnel)
    # -------------------------------------------------------------------------
    - name: Nettoyer le fichier de sc√©nario personnalis√©
      file:
        path: "{{ remote_test_dir }}/custom_scenario.json"
        state: absent
      when: 
        - scenario_file != ''
        - cleanup_after_test | bool
      tags: [cleanup]

# ============================================================================
# Fin du Playbook
# ============================================================================

# Made with Bob
