---
# ============================================================================
# Playbook Ansible Principal - Validation Compl√®te de Performance IBM i
# ============================================================================
# Ce playbook orchestre le workflow complet de validation de performance:
# 1. Collecte baseline avant mise √† jour
# 2. Pause pour appliquer la mise √† jour
# 3. Tests de validation apr√®s mise √† jour
# 4. Comparaison des r√©sultats
# 5. G√©n√©ration du rapport HTML
# ============================================================================
# Usage:
#   ansible-playbook -i inventory.ini main_performance_validation.yml
#   ansible-playbook -i inventory.ini main_performance_validation.yml --extra-vars "skip_baseline=true"
# ============================================================================

- name: Workflow Complet de Validation de Performance IBM i
  hosts: ibmi_stress_test
  gather_facts: yes
  
  vars_files:
    - vars.yml
  
  vars:
    # Noms des fichiers pour ce workflow
    workflow_id: "validation_{{ ansible_date_time.iso8601_basic_short }}"
    baseline_file_name: "baseline_{{ workflow_id }}.json"
    validation_file_name: "validation_{{ workflow_id }}.json"
    comparison_file_name: "comparison_{{ workflow_id }}.json"
    html_report_name: "report_{{ workflow_id }}.html"
    
  tasks:
    # =========================================================================
    # PHASE 1: COLLECTE BASELINE AVANT MISE √Ä JOUR
    # =========================================================================
    - name: "PHASE 1: Afficher le d√©but de la collecte baseline"
      debug:
        msg:
          - "=========================================="
          - "üéØ PHASE 1: COLLECTE BASELINE"
          - "=========================================="
          - "Workflow ID: {{ workflow_id }}"
          - "H√¥te: {{ inventory_hostname }}"
          - "Date: {{ ansible_date_time.iso8601 }}"
          - "=========================================="
      tags: [phase1, baseline]

    - name: "PHASE 1: Collecter la baseline de performance"
      include_tasks: collect_baseline.yml
      vars:
        baseline_name: "baseline_{{ workflow_id }}"
      when: not (skip_baseline | default(false) | bool)
      tags: [phase1, baseline]

    - name: "PHASE 1: Baseline collect√©e avec succ√®s"
      debug:
        msg:
          - "‚úÖ Baseline collect√©e et sauvegard√©e"
          - "Fichier: {{ local_results_dir }}/{{ baseline_file_name }}"
      when: not (skip_baseline | default(false) | bool)
      tags: [phase1, baseline]

    # =========================================================================
    # PHASE 2: PAUSE POUR MISE √Ä JOUR
    # =========================================================================
    - name: "PHASE 2: Instructions pour la mise √† jour"
      debug:
        msg:
          - "=========================================="
          - "‚è∏Ô∏è  PHASE 2: MISE √Ä JOUR DU SYST√àME"
          - "=========================================="
          - ""
          - "La baseline a √©t√© collect√©e avec succ√®s."
          - ""
          - "PROCHAINES √âTAPES:"
          - "1. Appliquez vos PTFs ou mises √† jour syst√®me"
          - "2. Red√©marrez le syst√®me si n√©cessaire"
          - "3. V√©rifiez que le syst√®me est stable"
          - "4. Relancez ce playbook avec --tags phase3"
          - ""
          - "COMMANDE POUR CONTINUER:"
          - "  ansible-playbook -i inventory.ini main_performance_validation.yml \\"
          - "    --tags phase3,phase4,phase5 \\"
          - "    --extra-vars \"baseline_file={{ local_results_dir }}/{{ baseline_file_name }}\""
          - ""
          - "=========================================="
      when: not (skip_baseline | default(false) | bool)
      tags: [phase2, update]

    - name: "PHASE 2: Pause pour permettre la mise √† jour"
      pause:
        prompt: |
          
          Appuyez sur ENTR√âE apr√®s avoir appliqu√© la mise √† jour et v√©rifi√© la stabilit√© du syst√®me.
          Ou appuyez sur Ctrl+C puis A pour annuler.
      when: 
        - not (skip_baseline | default(false) | bool)
        - not (auto_continue | default(false) | bool)
      tags: [phase2, update]

    # =========================================================================
    # PHASE 3: TESTS DE VALIDATION APR√àS MISE √Ä JOUR
    # =========================================================================
    - name: "PHASE 3: Afficher le d√©but des tests de validation"
      debug:
        msg:
          - "=========================================="
          - "üöÄ PHASE 3: TESTS DE VALIDATION"
          - "=========================================="
          - "Ex√©cution des tests de performance..."
          - "=========================================="
      tags: [phase3, validation]

    - name: "PHASE 3: Ex√©cuter les tests CPU de validation"
      include_tasks: run_cpu_stress.yml
      vars:
        results_file: "cpu_validation_{{ workflow_id }}.json"
      tags: [phase3, validation, cpu]

    - name: "PHASE 3: Ex√©cuter les tests I/O de validation"
      include_tasks: run_io_stress.yml
      vars:
        results_file: "io_validation_{{ workflow_id }}.json"
      tags: [phase3, validation, io]

    - name: "PHASE 3: Collecter la nouvelle baseline post-mise √† jour"
      include_tasks: collect_baseline.yml
      vars:
        baseline_name: "validation_{{ workflow_id }}"
      tags: [phase3, validation]

    - name: "PHASE 3: Tests de validation termin√©s"
      debug:
        msg:
          - "‚úÖ Tests de validation termin√©s"
          - "Fichier: {{ local_results_dir }}/{{ validation_file_name }}"
      tags: [phase3, validation]

    # =========================================================================
    # PHASE 4: COMPARAISON DES R√âSULTATS
    # =========================================================================
    - name: "PHASE 4: Afficher le d√©but de la comparaison"
      debug:
        msg:
          - "=========================================="
          - "üìä PHASE 4: COMPARAISON DES R√âSULTATS"
          - "=========================================="
          - "Analyse des diff√©rences de performance..."
          - "=========================================="
      tags: [phase4, compare]

    - name: "PHASE 4: V√©rifier l'existence des fichiers de baseline et validation"
      stat:
        path: "{{ item }}"
      loop:
        - "{{ baseline_file | default(local_results_dir + '/' + baseline_file_name) }}"
        - "{{ local_results_dir }}/{{ validation_file_name }}"
      register: comparison_files_check
      delegate_to: localhost
      tags: [phase4, compare]

    - name: "PHASE 4: Comparer les r√©sultats"
      include_tasks: compare_results.yml
      vars:
        baseline_file: "{{ baseline_file | default(local_results_dir + '/' + baseline_file_name) }}"
        validation_file: "{{ local_results_dir }}/{{ validation_file_name }}"
        comparison_report: "{{ comparison_file_name }}"
      when: comparison_files_check.results | selectattr('stat.exists') | list | length == 2
      tags: [phase4, compare]

    - name: "PHASE 4: Comparaison termin√©e"
      debug:
        msg:
          - "‚úÖ Comparaison termin√©e"
          - "Fichier: {{ local_reports_dir }}/{{ comparison_file_name }}"
      tags: [phase4, compare]

    # =========================================================================
    # PHASE 5: G√âN√âRATION DU RAPPORT HTML
    # =========================================================================
    - name: "PHASE 5: Afficher le d√©but de la g√©n√©ration du rapport"
      debug:
        msg:
          - "=========================================="
          - "üìÑ PHASE 5: G√âN√âRATION DU RAPPORT HTML"
          - "=========================================="
          - "Cr√©ation du rapport visuel..."
          - "=========================================="
      when: generate_html_report | bool
      tags: [phase5, report]

    - name: "PHASE 5: Charger les donn√©es de comparaison"
      set_fact:
        comparison_data: "{{ lookup('file', local_reports_dir + '/' + comparison_file_name) | from_json }}"
      when: generate_html_report | bool
      tags: [phase5, report]

    - name: "PHASE 5: Pr√©parer les variables pour le template HTML"
      set_fact:
        html_vars:
          hostname: "{{ inventory_hostname }}"
          report_date: "{{ ansible_date_time.iso8601 }}"
          baseline_date: "{{ comparison_data.metadata.baseline_date }}"
          validation_date: "{{ comparison_data.metadata.validation_date }}"
          overall_status: "{{ comparison_data.assessment.overall.status }}"
          cpu_baseline: "{{ comparison_data.comparisons.cpu.baseline.cpu_percent }}"
          cpu_validation: "{{ comparison_data.comparisons.cpu.validation.cpu_percent }}"
          cpu_change: "{{ comparison_data.comparisons.cpu.difference.cpu_percent }}"
          cpu_change_percent: "{{ comparison_data.comparisons.cpu.percentage_change.cpu_percent }}"
          cpu_status: "{{ comparison_data.assessment.cpu.status }}"
          memory_baseline: "{{ comparison_data.comparisons.memory.baseline.percent }}"
          memory_validation: "{{ comparison_data.comparisons.memory.validation.percent }}"
          memory_change: "{{ comparison_data.comparisons.memory.difference.percent }}"
          memory_change_percent: "{{ comparison_data.comparisons.memory.percentage_change.percent }}"
          memory_status: "{{ comparison_data.assessment.memory.status }}"
          memory_used_baseline: "{{ comparison_data.comparisons.memory.baseline.used_gb }}"
          memory_used_validation: "{{ comparison_data.comparisons.memory.validation.used_gb }}"
          memory_used_change: "{{ comparison_data.comparisons.memory.difference.used_gb }}"
          disk_baseline: "{{ comparison_data.comparisons.disk.baseline.percent }}"
          disk_validation: "{{ comparison_data.comparisons.disk.validation.percent }}"
          disk_change: "{{ comparison_data.comparisons.disk.difference.percent }}"
          load_avg_baseline: "{{ comparison_data.comparisons.cpu.baseline.load_avg_1min }}"
          load_avg_validation: "{{ comparison_data.comparisons.cpu.validation.load_avg_1min }}"
          load_avg_change: "{{ comparison_data.comparisons.cpu.difference.load_avg_1min }}"
          recommendations: "{{ comparison_data.recommendations }}"
          os_version: "{{ comparison_data.system_info.baseline.os }}"
          cpu_count: "{{ comparison_data.system_info.baseline.processor_vcpus }}"
          memory_total: "{{ (comparison_data.system_info.baseline.memory_mb | int / 1024) | round(2) }}"
      when: generate_html_report | bool
      tags: [phase5, report]

    - name: "PHASE 5: G√©n√©rer le rapport HTML"
      template:
        src: templates/performance_report.html.j2
        dest: "{{ local_reports_dir }}/{{ html_report_name }}"
      vars: "{{ html_vars }}"
      delegate_to: localhost
      when: generate_html_report | bool
      tags: [phase5, report]

    - name: "PHASE 5: Rapport HTML g√©n√©r√©"
      debug:
        msg:
          - "‚úÖ Rapport HTML g√©n√©r√© avec succ√®s"
          - "Fichier: {{ local_reports_dir }}/{{ html_report_name }}"
          - ""
          - "Pour visualiser:"
          - "  open {{ local_reports_dir }}/{{ html_report_name }}"
      when: generate_html_report | bool
      tags: [phase5, report]

    # =========================================================================
    # R√âSUM√â FINAL
    # =========================================================================
    - name: "Afficher le r√©sum√© final du workflow"
      debug:
        msg:
          - "=========================================="
          - "‚úÖ WORKFLOW DE VALIDATION TERMIN√â"
          - "=========================================="
          - "Workflow ID: {{ workflow_id }}"
          - "H√¥te: {{ inventory_hostname }}"
          - ""
          - "Fichiers g√©n√©r√©s:"
          - "  üìä Baseline: {{ local_results_dir }}/{{ baseline_file_name }}"
          - "  üìä Validation: {{ local_results_dir }}/{{ validation_file_name }}"
          - "  üìä Comparaison: {{ local_reports_dir }}/{{ comparison_file_name }}"
          - "  üìÑ Rapport HTML: {{ local_reports_dir }}/{{ html_report_name }}"
          - ""
          - "Statut: {{ comparison_data.assessment.overall.status if comparison_data is defined else 'N/A' }}"
          - ""
          - "Pour visualiser le rapport:"
          - "  open {{ local_reports_dir }}/{{ html_report_name }}"
          - "=========================================="
      tags: [summary]

# ============================================================================
# Fin du Playbook Principal
# ============================================================================

# Made with Bob
