---
###############################################################################
# Rôle: sriov_validate
# Description: Validation de la configuration SR-IOV
###############################################################################

- name: "Banner - Début de la validation"
  debug:
    msg:
      - "════════════════════════════════════════════════════════"
      - "  Phase 3: Validation de la Configuration SR-IOV"
      - "════════════════════════════════════════════════════════"

###############################################################################
# Validation de la ligne de communication
###############################################################################

- name: "Vérifier le statut de la ligne"
  ibmi_sql_query:
    sql: |
      SELECT LINE_NAME, LINE_TYPE, LINE_STATUS, RESOURCE_NAME, 
             LINE_SPEED, DUPLEX_MODE, AUTO_START
      FROM QSYS2.NETSTAT_LINE_INFO
      WHERE LINE_NAME = '{{ line_description }}'
  register: line_validation

- name: "Afficher les détails de la ligne"
  debug:
    msg:
      - "Ligne: {{ line_validation.row[0].LINE_NAME }}"
      - "Type: {{ line_validation.row[0].LINE_TYPE }}"
      - "Statut: {{ line_validation.row[0].LINE_STATUS }}"
      - "Ressource: {{ line_validation.row[0].RESOURCE_NAME }}"
      - "Vitesse: {{ line_validation.row[0].LINE_SPEED }}"
      - "Duplex: {{ line_validation.row[0].DUPLEX_MODE }}"

- name: "Vérifier que la ligne est active"
  assert:
    that:
      - line_validation.row | length > 0
      - line_validation.row[0].LINE_STATUS == 'ACTIVE'
    fail_msg: "✗ La ligne {{ line_description }} n'est pas active"
    success_msg: "✓ Ligne {{ line_description }} active"

###############################################################################
# Validation de l'interface TCP/IP
###############################################################################

- name: "Vérifier le statut de l'interface TCP/IP"
  ibmi_sql_query:
    sql: |
      SELECT INTERFACE_NAME, INTERNET_ADDRESS, INTERFACE_STATUS, 
             LINE_DESCRIPTION, SUBNET_MASK, NETWORK_ADDRESS,
             MAXIMUM_TRANSMISSION_UNIT
      FROM QSYS2.NETSTAT_INTERFACE_INFO
      WHERE INTERNET_ADDRESS = '{{ ip_address }}'
  register: interface_validation

- name: "Afficher les détails de l'interface"
  debug:
    msg:
      - "Interface: {{ interface_validation.row[0].INTERFACE_NAME }}"
      - "Adresse IP: {{ interface_validation.row[0].INTERNET_ADDRESS }}"
      - "Statut: {{ interface_validation.row[0].INTERFACE_STATUS }}"
      - "Ligne: {{ interface_validation.row[0].LINE_DESCRIPTION }}"
      - "Masque: {{ interface_validation.row[0].SUBNET_MASK }}"
      - "MTU: {{ interface_validation.row[0].MAXIMUM_TRANSMISSION_UNIT }}"

- name: "Vérifier que l'interface est active"
  assert:
    that:
      - interface_validation.row | length > 0
      - interface_validation.row[0].INTERFACE_STATUS == 'ACTIVE'
      - interface_validation.row[0].INTERNET_ADDRESS == ip_address
    fail_msg: "✗ L'interface {{ interface_name }} n'est pas correctement configurée"
    success_msg: "✓ Interface {{ interface_name }} active et configurée"

###############################################################################
# Validation de la route par défaut
###############################################################################

- name: "Vérifier la route par défaut"
  ibmi_sql_query:
    sql: |
      SELECT ROUTE_DESTINATION, NEXT_HOP, ROUTE_TYPE, ROUTE_STATUS
      FROM QSYS2.NETSTAT_ROUTE_INFO
      WHERE ROUTE_TYPE = '*DFTROUTE'
  register: route_validation

- name: "Afficher la route par défaut"
  debug:
    msg:
      - "Route: {{ route_validation.row[0].ROUTE_DESTINATION }}"
      - "Passerelle: {{ route_validation.row[0].NEXT_HOP }}"
      - "Type: {{ route_validation.row[0].ROUTE_TYPE }}"
      - "Statut: {{ route_validation.row[0].ROUTE_STATUS }}"
  when: route_validation.row | length > 0

- name: "Vérifier que la route par défaut existe"
  assert:
    that:
      - route_validation.row | length > 0
    fail_msg: "✗ Aucune route par défaut configurée"
    success_msg: "✓ Route par défaut configurée"

###############################################################################
# Tests de connectivité
###############################################################################

- name: "Test de connectivité - Ping vers la passerelle"
  ibmi_cl_command:
    cmd: "PING RMTSYS('{{ gateway }}') NBRPKT({{ validation_tests.ping_count | default(10) }})"
  register: ping_gateway
  ignore_errors: yes
  when: validation_tests.ping_gateway | default(true)

- name: "Résultat du ping vers la passerelle"
  debug:
    msg: "{% if ping_gateway is succeeded %}✓ Ping vers {{ gateway }} réussi{% else %}✗ Ping vers {{ gateway }} échoué{% endif %}"
  when: validation_tests.ping_gateway | default(true)

- name: "Test de connectivité - Ping vers un hôte externe"
  ibmi_cl_command:
    cmd: "PING RMTSYS('{{ validation_tests.external_host | default('8.8.8.8') }}') NBRPKT({{ validation_tests.ping_count | default(10) }})"
  register: ping_external
  ignore_errors: yes
  when: validation_tests.ping_external | default(true)

- name: "Résultat du ping externe"
  debug:
    msg: "{% if ping_external is succeeded %}✓ Ping externe réussi{% else %}⚠ Ping externe échoué (vérifier le routage){% endif %}"
  when: validation_tests.ping_external | default(true)

###############################################################################
# Validation des statistiques réseau
###############################################################################

- name: "Récupérer les statistiques de l'interface"
  ibmi_sql_query:
    sql: |
      SELECT INTERFACE_NAME, BYTES_SENT, BYTES_RECEIVED,
             PACKETS_SENT, PACKETS_RECEIVED,
             OUTPUT_ERRORS, INPUT_ERRORS
      FROM QSYS2.NETSTAT_INTERFACE_INFO
      WHERE INTERNET_ADDRESS = '{{ ip_address }}'
  register: interface_stats

- name: "Afficher les statistiques réseau"
  debug:
    msg:
      - "Octets envoyés: {{ interface_stats.row[0].BYTES_SENT }}"
      - "Octets reçus: {{ interface_stats.row[0].BYTES_RECEIVED }}"
      - "Paquets envoyés: {{ interface_stats.row[0].PACKETS_SENT }}"
      - "Paquets reçus: {{ interface_stats.row[0].PACKETS_RECEIVED }}"
      - "Erreurs sortie: {{ interface_stats.row[0].OUTPUT_ERRORS }}"
      - "Erreurs entrée: {{ interface_stats.row[0].INPUT_ERRORS }}"

- name: "Vérifier l'absence d'erreurs réseau"
  debug:
    msg: "{% if interface_stats.row[0].OUTPUT_ERRORS == 0 and interface_stats.row[0].INPUT_ERRORS == 0 %}✓ Aucune erreur réseau détectée{% else %}⚠ Erreurs réseau détectées{% endif %}"

###############################################################################
# Validation de la configuration matérielle
###############################################################################

- name: "Vérifier la ressource matérielle"
  ibmi_sql_query:
    sql: |
      SELECT RESOURCE_NAME, RESOURCE_TYPE, RESOURCE_STATUS, DESCRIPTION
      FROM QSYS2.SYSTEM_HARDWARE_RESOURCE
      WHERE RESOURCE_NAME = '{{ resource_name }}'
  register: hardware_validation
  when: resource_name is defined

- name: "Afficher le statut matériel"
  debug:
    msg:
      - "Ressource: {{ hardware_validation.row[0].RESOURCE_NAME }}"
      - "Type: {{ hardware_validation.row[0].RESOURCE_TYPE }}"
      - "Statut: {{ hardware_validation.row[0].RESOURCE_STATUS }}"
      - "Description: {{ hardware_validation.row[0].DESCRIPTION }}"
  when: 
    - resource_name is defined
    - hardware_validation.row | length > 0

###############################################################################
# Test de résolution DNS (optionnel)
###############################################################################

- name: "Test de résolution DNS"
  ibmi_cl_command:
    cmd: "PING RMTSYS('{{ validation_tests.test_hostname | default('www.ibm.com') }}') NBRPKT(3)"
  register: dns_test
  ignore_errors: yes
  when: validation_tests.dns_resolution | default(false)

- name: "Résultat du test DNS"
  debug:
    msg: "{% if dns_test is succeeded %}✓ Résolution DNS fonctionnelle{% else %}⚠ Résolution DNS échouée{% endif %}"
  when: validation_tests.dns_resolution | default(false)

###############################################################################
# Test de performance (optionnel)
###############################################################################

- name: "Test de latence réseau"
  ibmi_cl_command:
    cmd: "PING RMTSYS('{{ gateway }}') NBRPKT(100) PKTSIZE(1500)"
  register: latency_test
  ignore_errors: yes
  when: validation_tests.latency_test | default(false)

- name: "Résultat du test de latence"
  debug:
    msg: "Test de latence effectué (100 paquets de 1500 octets)"
  when: 
    - validation_tests.latency_test | default(false)
    - latency_test is succeeded

###############################################################################
# Génération du rapport de validation
###############################################################################

- name: "Créer le répertoire de rapports"
  file:
    path: "{{ backup_directory | default('/tmp/sriov_backups') }}"
    state: directory
    mode: '0755'
  delegate_to: localhost

- name: "Générer le rapport de validation"
  template:
    src: validation_report.j2
    dest: "{{ backup_directory | default('/tmp/sriov_backups') }}/validation_report_{{ ansible_date_time.date }}.txt"
  delegate_to: localhost

###############################################################################
# Résumé de la validation
###############################################################################

- name: "Calculer le score de validation"
  set_fact:
    validation_score: >-
      {{
        (
          (line_validation.row | length > 0 and line_validation.row[0].LINE_STATUS == 'ACTIVE') | int +
          (interface_validation.row | length > 0 and interface_validation.row[0].INTERFACE_STATUS == 'ACTIVE') | int +
          (route_validation.row | length > 0) | int +
          (ping_gateway is succeeded | default(false)) | int +
          (interface_stats.row[0].OUTPUT_ERRORS == 0 and interface_stats.row[0].INPUT_ERRORS == 0) | int
        ) * 20
      }}

- name: "Banner - Fin de la validation"
  debug:
    msg:
      - "════════════════════════════════════════════════════════"
      - "  ✓ Validation Terminée"
      - "  Score de validation: {{ validation_score }}%"
      - "  {% if validation_score | int == 100 %}Configuration parfaite !{% elif validation_score | int >= 80 %}Configuration fonctionnelle{% else %}Configuration à améliorer{% endif %}"
      - "════════════════════════════════════════════════════════"

# Made with Bob
